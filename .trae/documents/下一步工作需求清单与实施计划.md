## 现状对照
1. Phase 0-4 已有“最小闭环”可跑：OpenAI 兼容路由 + SSE + Tool Loop + MCP 注入 + LSP Mock + Planner 最小 plan 执行/汇总。
2. 还缺的是“计划书里验收口径要求的可靠性/完整性”，主要集中在：真实流式、MCP/LSP 的真实能力面、Planner 的自纠错与恢复、以及安全与回归体系。

## 下一步仍需完成的工作需求（按优先级）
### 1) MCP（Phase 2 验收口径尚未满足）
- 工具清单刷新：提供刷新机制（启动后可重新拉取 tools/list，而非只在启动时一次）。
- 调用护栏：每次 tools/call 的超时、并发上限、失败隔离（单个 MCP Server 异常不拖垮整个 runtime）。
- 观测：把 MCP 侧错误（网络/JSON-RPC 错误/超时）结构化回填到 TOOL_RESULT，并在 trace 中可定位。

### 2) LSP Facade（Phase 3 仅有 Mock，未达“5 类能力闭环”）
- 需要落地至少 5 类核心工具：文件读取/写入/搜索、诊断、hover/definition、引用/rename、格式化/重构（具体以 IDE 侧 MCP Tool Server 能提供的能力为准）。
- 权限与一致性：工作区根目录约束、路径规范化、防越界；避免 runtime 成为第二个 LSP client 争抢状态（由 IDE 侧工具驱动 LSP）。

### 3) Planner（Phase 4 当前仅“最小闭环”，未达“自纠错/Workflow/可恢复”）
- Plan 表示与校验：严格校验 plan steps（工具名必须在 allowlist、参数需符合 schema；不合法要拒绝/让模型重写）。
- 逐步执行引擎：step 状态、失败策略（重试次数、回退/改写）、终止条件（预算/最大轮次/最大错误数）。
- 可恢复/可终止：中断后能安全终止或续跑（至少实现“幂等重放/不重复执行危险工具”的保护）。
- Workflow 模板：为常见任务（例如“定位→读取→诊断→修改→验证”）提供可复用模板，让模型少走弯路。

### 4) 关键未决项/技术债（直接影响稳定性）
- 上游（Ollama）真实流式：当前是“非流式上游 + SSE 模拟分片”，未满足真实 token 级体验。
- `/v1/responses` 的字段子集与和 chat.completions 的映射规则需要冻结并补齐。
- 会话持久化：目前以内存为主，长任务/恢复能力不足。
- Provider 统一语义：取消/超时/错误映射需要统一抽象。

## 推荐的下一步实现顺序（1 个迭代内可交付）
## 目标：把 Phase 2-4 从“能跑”提升到“可控且可回归”
1. MCP 硬化：为 MCP 调用加入超时/并发限制/失败隔离 + tools 刷新能力。
2. LSP Facade v0：先落地 5 个最小工具（read/search/diagnostics/hover/definition）并加工作区安全约束。
3. Planner v1：对 plan steps 做 schema 校验 + 失败重试策略（例如最多 2 次重写计划）+ 严格终止条件。
4. 回归用例：新增一组“planner + lsp tools + tool failure”用例，确保 allowlist/预算/重试逻辑不回退。

## 交付物
- 新增/完善的 MCP/LSP/Planner 能力与参数（对外仍保持 OpenAI 兼容请求体为主）。
- 扩展 trace：能在一次请求中看见 plan、每一步结果、重试原因与终止原因。
- 更新开发计划：把 Phase 2-4 的“验收口径”逐条对齐到已实现项。

如确认该计划，我将从“MCP 调用护栏 + tools 刷新（Phase 2 验收口径）”开始落地，再推进 LSP Facade 5 类能力与 Planner v1。